<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MineSafe - Upload Data</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        :root {
            --primary-color: #1193d4;
            --primary-dark: #0d7bb8;
        }
        body {
            font-family: 'Inter', 'Space Grotesk', sans-serif;
            background-color: #111618;
        }
    </style>
</head>
<body class="text-white">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-[#192633] p-6 flex flex-col">
            <div class="flex items-center gap-3 mb-10">
                <div class="size-8 text-white">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 42.4379C4 42.4379 14.0962 36.0744 24 41.1692C35.0664 46.8624 44 42.2078 44 42.2078L44 7.01134C44 7.01134 35.068 11.6577 24.0031 5.96913C14.0971 0.876274 4 7.27094 4 7.27094L4 42.4379Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h1 class="text-xl font-bold">MineSafe</h1>
            </div>
            <nav class="flex flex-col gap-2 flex-grow">
                <a href="{{ url_for('index') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
                    <span class="material-symbols-outlined">dashboard</span>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('predictions') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
                    <span class="material-symbols-outlined">model_training</span>
                    <span>Predictions</span>
                </a>
                <a href="{{ url_for('alerts') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
                    <span class="material-symbols-outlined">notifications_active</span>
                    <span>Alerts</span>
                </a>
                <a href="{{ url_for('upload') }}" class="flex items-center gap-3 px-4 py-2 rounded-md bg-[#233648] text-white">
                    <span class="material-symbols-outlined">upload_file</span>
                    <span>Upload Data</span>
                </a>
                <a href="{{ url_for('results') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
                    <span class="material-symbols-outlined">summarize</span>
                    <span>Results</span>
                </a>
                <a href="{{ url_for('chatbot') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
                    <span class="material-symbols-outlined">smart_toy</span>
                    <span>AI Assistant</span>
                </a>
            </nav>
            <div class="mt-auto">
                <button class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 cursor-default">
                    <span class="material-symbols-outlined">settings</span>
                    <span>Settings</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8">
            <header class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold">Upload Data</h1>
                    <p class="text-gray-400">Upload CSV data to generate rockfall predictions automatically</p>
                </div>
                <div class="flex items-center gap-4">
                    <button class="p-2 rounded-full bg-[#192633] hover:bg-[#233648] transition-colors">
                        <span class="material-symbols-outlined">notifications</span>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="size-10 rounded-full bg-cover bg-center" style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuA1vinqA5VrtThhnhWfWhSvZ_Rkj7QMn9cl6rva3UDsOgBvXzpyCXLj4GRTyAVR0dldRZsadvsHFcCzUQ1fmIRLbYN1XGdNVgB9ktT9rEXjPsAybJ2L9HCjbUvQz0xl_EVtCqh8M8uHH7_Nx1Ul3kOxmTGOKU2M6E9YoMbEB5lliXHptFft3el71vuloWSAjTsx9bLj-Wri4ZKJJegVW9qgbjEp9LV_ghzZUqeA1nSf7V1Q6AO201-pPLBUF4-KrWqC32Yg87ahfvor');"></div>
                        <span class="material-symbols-outlined text-gray-400">expand_more</span>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Upload Area -->
                <div class="bg-[#1a2024] p-6 rounded-lg border border-[#283339]">
                    <h2 class="text-xl font-bold text-white mb-4">Upload CSV Data</h2>
                    <p class="text-gray-400 mb-6">Upload your rockfall sensor data in CSV format to generate predictions automatically.</p>
                    
                    <form id="upload-form" enctype="multipart/form-data">
                        <div id="dropzone" class="border-2 border-dashed border-[#324d67] rounded-lg p-12 text-center hover:border-[#1193d4] hover:bg-[#0f1820] transition-all cursor-pointer">
                            <span class="material-symbols-outlined text-4xl text-gray-400 mb-4 block">upload_file</span>
                            <p class="text-gray-300 font-medium">Click to upload or drag and drop</p>
                            <p class="text-gray-400 text-sm mt-2">CSV files only</p>
                            <input type="file" id="file-input" name="file" accept=".csv" class="hidden">
                        </div>
                    </form>

                    <div id="file-meta" class="hidden mt-4 p-4 bg-[#111618] rounded-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-[#1193d4]">description</span>
                                <div>
                                    <p id="file-name" class="text-white font-medium"></p>
                                    <p id="file-size" class="text-gray-400 text-sm"></p>
                                </div>
                            </div>
                            <button id="run-btn" type="button" class="flex items-center gap-2 px-4 py-2 bg-[#1193d4] text-white rounded-md hover:bg-opacity-80 transition-colors" disabled>
                                <span class="material-symbols-outlined text-sm">model_training</span>
                                Generate Predictions
                            </button>
                        </div>
                    </div>

                    <div id="upload-status" class="hidden mt-4"></div>
                </div>

                <!-- Data Preview -->
                <div class="bg-[#1a2024] p-6 rounded-lg border border-[#283339]">
                    <h3 class="text-lg font-bold text-white mb-4">Data Preview</h3>
                    <div id="preview-empty" class="text-center py-12">
                        <span class="material-symbols-outlined text-4xl text-gray-400 mb-4 block">table_view</span>
                        <p class="text-gray-400">Upload a file to see data preview</p>
                    </div>
                    <div id="preview-table" class="hidden overflow-x-auto rounded-lg border border-[#324d67]">
                        <table class="w-full text-left">
                            <thead class="bg-[#111a22]" id="table-head"></thead>
                            <tbody class="divide-y divide-[#324d67]" id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="hidden mt-8 bg-[#1a2024] p-6 rounded-lg border border-[#283339]">
                <h3 class="text-lg font-bold text-white mb-4">Prediction Results</h3>
                <div id="prediction-results"></div>
                <div class="flex justify-end mt-4">
                    <a href="{{ url_for('predictions') }}" class="flex items-center gap-2 px-4 py-2 bg-[#1193d4] text-white rounded-md hover:bg-opacity-80 transition-colors">
                        <span class="material-symbols-outlined text-sm">open_in_new</span>
                        View Full Results
                    </a>
                </div>
            </div>
        </main>
    </div>

    <script>
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const fileMeta = document.getElementById('file-meta');
        const fileNameEl = document.getElementById('file-name');
        const fileSizeEl = document.getElementById('file-size');
        const headEl = document.getElementById('table-head');
        const bodyEl = document.getElementById('table-body');
        const previewEmpty = document.getElementById('preview-empty');
        const previewTable = document.getElementById('preview-table');
        const runBtn = document.getElementById('run-btn');
        const uploadStatus = document.getElementById('upload-status');
        const resultsSection = document.getElementById('results-section');
        const predictionResults = document.getElementById('prediction-results');

        function bytesToSize(bytes){
            const sizes=['B','KB','MB','GB'];
            if(bytes===0) return '0 B';
            const i=parseInt(Math.floor(Math.log(bytes)/Math.log(1024)),10);
            return (bytes/Math.pow(1024,i)).toFixed(1)+' '+sizes[i];
        }

        function setActiveDrop(active){
            dropzone.classList.toggle('border-[#1193d4]', active);
            dropzone.classList.toggle('bg-[#0f1820]', active);
        }

        function showStatus(message, isError = false) {
            uploadStatus.innerHTML = `
                <div class="p-3 rounded-md ${isError ? 'bg-red-900/30 border border-red-500' : 'bg-green-900/30 border border-green-500'}">
                    <p class="${isError ? 'text-red-400' : 'text-green-400'}">${message}</p>
                </div>
            `;
            uploadStatus.classList.remove('hidden');
        }

        function parseCSV(text){
            const rows=[]; let cur=''; let row=[]; let inQuotes=false; const pushCell=()=>{ row.push(cur); cur=''; };
            for(let i=0;i<text.length;i++){
                const ch=text[i];
                if(ch==='"'){
                    if(inQuotes && text[i+1]==='"'){ cur+='"'; i++; }
                    else inQuotes=!inQuotes;
                } else if(ch===',' && !inQuotes){ pushCell(); }
                else if((ch==='\n' || ch==='\r') && !inQuotes){ if(cur!=='' || row.length){ pushCell(); rows.push(row); row=[]; } }
                else { cur+=ch; }
            }
            if(cur!=='' || row.length){ pushCell(); rows.push(row); }
            return rows.filter(r=>r.some(c=>c && c.trim()!==''));
        }

        function renderPreview(rows){
            const headers = rows[0] || [];
            headEl.innerHTML = '<tr>' + headers.map(h=>`<th class="px-4 py-3 text-xs font-semibold uppercase tracking-wide text-gray-300">${h||''}</th>`).join('') + '</tr>';
            const maxRows = Math.min(5, rows.length-1);
            bodyEl.innerHTML = Array.from({length:maxRows}, (_,i)=>{
                const r = rows[i+1] || [];
                return '<tr>'+ r.map(c=>`<td class="px-4 py-2 text-sm text-gray-200">${(c??'')}</td>`).join('') + '</tr>';
            }).join('');
            previewEmpty.classList.add('hidden');
            previewTable.classList.remove('hidden');
        }

        function displayResults(data) {
            const predictions = data.predictions || [];
            const probabilities = data.probabilities || [];
            
            let html = `
                <div class="mb-4 p-4 bg-[#111618] rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-white font-medium">Upload Summary</span>
                        <span class="text-green-400">✓ Success</span>
                    </div>
                    <div class="text-sm text-gray-400">
                        <p>Data rows: ${data.data_rows || 0}</p>
                        <p>Generated predictions: ${predictions.length}</p>
                        <p>Model used: ${data.model_used || 'Unknown'}</p>
                    </div>
                </div>
                <div class="space-y-3">
            `;
            
            predictions.slice(0, 5).forEach((pred, i) => {
                const prob = probabilities[i] || {};
                const confidence = prob[pred] || 0;
                html += `
                    <div class="flex items-center justify-between p-3 bg-[#111618] rounded-md">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full ${
                                pred === 'Low' ? 'bg-green-500' : 
                                pred === 'Medium' ? 'bg-yellow-500' : 
                                pred === 'High' ? 'bg-orange-500' : 'bg-red-500'
                            }"></div>
                            <span class="text-white">Row ${i + 1}: ${pred} Risk</span>
                        </div>
                        <span class="text-gray-400 text-sm">${(confidence * 100).toFixed(1)}% confidence</span>
                    </div>
                `;
            });
            
            html += '</div>';
            predictionResults.innerHTML = html;
            resultsSection.classList.remove('hidden');
        }

        dropzone.addEventListener('dragover', e=>{ e.preventDefault(); setActiveDrop(true); });
        dropzone.addEventListener('dragleave', ()=> setActiveDrop(false));
        dropzone.addEventListener('drop', e=>{
            e.preventDefault(); setActiveDrop(false);
            if(e.dataTransfer.files && e.dataTransfer.files[0]){
                handleFile(e.dataTransfer.files[0]);
            }
        });
        dropzone.addEventListener('click', ()=> fileInput.click());
        fileInput.addEventListener('change', ()=>{
            if(fileInput.files[0]) handleFile(fileInput.files[0]);
        });

        function handleFile(file){
            if(!file.name.toLowerCase().endsWith('.csv')){ 
                showStatus('Please select a CSV file.', true); 
                return; 
            }
            
            fileNameEl.textContent = file.name;
            fileSizeEl.textContent = bytesToSize(file.size);
            fileMeta.classList.remove('hidden');
            runBtn.disabled = false;
            
            const reader = new FileReader();
            reader.onload = () => {
                const text = reader.result;
                const rows = parseCSV(text);
                if(!rows.length){ 
                    showStatus('CSV appears empty.', true); 
                    return; 
                }
                renderPreview(rows);
            };
            reader.readAsText(file);
        }

        runBtn.addEventListener('click', ()=>{
            const file = fileInput.files[0];
            if (!file) return;

            runBtn.innerHTML = '<span class="material-symbols-outlined mr-2 text-sm animate-spin">progress_activity</span>Processing...';
            runBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus(data.message);
                    displayResults(data);
                } else {
                    showStatus(data.error || 'Upload failed', true);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showStatus('Network error occurred', true);
            })
            .finally(() => {
                runBtn.innerHTML = '<span class="material-symbols-outlined mr-2 text-sm">model_training</span>Generate Predictions';
                runBtn.disabled = false;
            });
        });
    </script>
</body>
</html>
