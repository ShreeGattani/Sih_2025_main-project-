<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="        <div class="rounded-lg border border-[#233648] bg-[#192633] p-4 space-y-4">
          <h3 class="text-lg font-semibold">Quick Prompts</h3>
          <div class="grid grid-cols-1 gap-2">
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">Is it safe to work today? My pincode is 110001</button>
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">What safety measures should I take during mining?</button>
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">How do I handle rockfall alerts?</button>
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">What are the signs of unstable ground?</button>
          </div>
        </div>ice-width, initial-scale=1.0" />
  <title>MineSafe - AI Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <style>
    :root { --primary-color:#1193d4; --primary-dark:#0d7bb8; }
    body { font-family:'Inter','Space Grotesk',sans-serif; background-color:#111618; }
    .message { max-width: 70%; }
  </style>
</head>
<body class="text-white">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-[#192633] p-6 flex flex-col">
      <div class="flex items-center gap-3 mb-10">
        <div class="size-8 text-white">
          <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M4 42.4379C4 42.4379 14.0962 36.0744 24 41.1692C35.0664 46.8624 44 42.2078 44 42.2078L44 7.01134C44 7.01134 35.068 11.6577 24.0031 5.96913C14.0971 0.876274 4 7.27094 4 7.27094L4 42.4379Z" fill="currentColor"/></svg>
        </div>
        <h1 class="text-xl font-bold">MineSafe</h1>
      </div>
      <nav class="flex flex-col gap-2 flex-grow">
        <a href="{{ url_for('index') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
          <span class="material-symbols-outlined">dashboard</span>
          <span>Dashboard</span>
        </a>
        <a href="{{ url_for('predictions') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
          <span class="material-symbols-outlined">model_training</span>
          <span>Predictions</span>
        </a>
        <a href="{{ url_for('alerts') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
          <span class="material-symbols-outlined">notifications_active</span>
          <span>Alerts</span>
        </a>
        <a href="{{ url_for('upload') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
          <span class="material-symbols-outlined">upload_file</span>
          <span>Upload Data</span>
        </a>
        <a href="{{ url_for('results') }}" class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 hover:bg-[#233648] hover:text-white transition-colors">
          <span class="material-symbols-outlined">summarize</span>
          <span>Results</span>
        </a>
        <a href="{{ url_for('chatbot') }}" class="flex items-center gap-3 px-4 py-2 rounded-md bg-[#233648] text-white">
          <span class="material-symbols-outlined">smart_toy</span>
          <span>AI Assistant</span>
        </a>
      </nav>
      <div class="mt-auto">
        <button class="flex items-center gap-3 px-4 py-2 rounded-md text-gray-400 cursor-default">
          <span class="material-symbols-outlined">settings</span>
          <span>Settings</span>
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 flex flex-col">
      <header class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-3xl font-bold">AI Assistant</h1>
          <p class="text-gray-400">Ask questions about your data, alerts, and predictions.</p>
        </div>
        <div class="flex items-center gap-2">
          <button class="p-2 rounded-full bg-[#192633] hover:bg-[#233648] transition-colors">
            <span class="material-symbols-outlined">notifications</span>
          </button>
          <div class="flex items-center gap-2">
            <div class="size-10 rounded-full bg-cover bg-center" style="background-image:url('https://lh3.googleusercontent.com/aida-public/AB6AXuA1vinqA5VrtThhnhWfWhSvZ_Rkj7QMn9cl6rva3UDsOgBvXzpyCXLj4GRTyAVR0dldRZsadvsHFcCzUQ1fmIRLbYN1XGdNVgB9ktT9rEXjPsAybJ2L9HCjbUvQz0xl_EVtCqh8M8uHH7_Nx1Ul3kOxmTGOKU2M6E9YoMbEB5lliXHptFft3el71vuloWSAjTsx9bLj-Wri4ZKJJegVW9qgbjEp9LV_ghzZUqeA1nSf7V1Q6AO201-pPLBUF4-KrWqC32Yg87ahfvor');"></div>
            <span class="material-symbols-outlined text-gray-400">expand_more</span>
          </div>
        </div>
      </header>

      <section class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 rounded-lg border border-[#233648] bg-[#192633] flex flex-col">
          <div id="chat" class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="flex gap-3">
              <div class="shrink-0"><span class="material-symbols-outlined text-[#1193d4]">smart_toy</span></div>
              <div class="message rounded-lg bg-[#111a22] p-3">
                <p class="text-sm">Hi! I'm your MineSafe assistant. Ask me about recent alerts, risk levels, or upload guidance.</p>
              </div>
            </div>
          </div>
          <div class="border-t border-[#233648] p-3">
            <form id="chat-form" class="flex items-end gap-2">
              <div class="relative flex-1">
                <textarea id="chat-input" rows="1" class="w-full resize-none rounded-md border border-[#324d67] bg-[#111a22] pr-24 text-white placeholder:text-gray-400 focus:border-[#1193d4] focus:ring-[#1193d4] p-3" placeholder="Type a message..."></textarea>
                <div class="absolute right-2 bottom-2 flex items-center gap-1">
                  <button type="button" id="suggest-btn" class="px-2 py-1 text-xs rounded bg-[#223243] text-gray-200 hover:bg-[#2a4058]">Suggest</button>
                </div>
              </div>
              <button id="send-btn" class="h-10 px-4 rounded-md bg-[#1193d4] text-white font-semibold hover:bg-[#0f7fb9] flex items-center gap-1">
                <span class="material-symbols-outlined">send</span>
                <span>Send</span>
              </button>
            </form>
          </div>
        </div>
        <div class="rounded-lg border border-[#233648] bg-[#192633] p-4 space-y-4">
          <h3 class="text-lg font-semibold">Quick Prompts</h3>
          <div class="grid grid-cols-1 gap-2">
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">Summarize todayâ€™s risk and active alerts</button>
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">What mitigation actions do you recommend?</button>
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">Help me map columns for a new CSV upload</button>
            <button class="prompt px-3 py-2 rounded-md bg-[#223243] text-left hover:bg-[#2a4058]">Explain the latest prediction chart</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const chat = document.getElementById('chat');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestBtn = document.getElementById('suggest-btn');

    function addMessage(text, from='user', type='general'){
      const row = document.createElement('div');
      row.className = 'flex gap-3 ' + (from==='user' ? 'justify-end' : '');
      const bubble = document.createElement('div');
      bubble.className = 'message rounded-lg p-3 ' + (from==='user' ? 'bg-[#1193d4] text-white' : 'bg-[#111a22]');
      
      // Format message based on type
      if (type === 'safety_check' && from === 'assistant') {
        bubble.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${text}</pre>`;
      } else if (type === 'weather' && from === 'assistant') {
        bubble.innerHTML = `<pre class="whitespace-pre-wrap text-sm">${text}</pre>`;
      } else {
        bubble.innerText = text;
      }
      
      if(from==='assistant'){
        const icon = document.createElement('div');
        icon.className = 'shrink-0';
        icon.innerHTML = '<span class="material-symbols-outlined text-[#1193d4]">smart_toy</span>';
        row.appendChild(icon);
        row.appendChild(bubble);
      } else {
        row.appendChild(bubble);
      }
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function showTyping() {
      const row = document.createElement('div');
      row.className = 'flex gap-3';
      row.id = 'typing-indicator';
      
      const icon = document.createElement('div');
      icon.className = 'shrink-0';
      icon.innerHTML = '<span class="material-symbols-outlined text-[#1193d4]">smart_toy</span>';
      
      const bubble = document.createElement('div');
      bubble.className = 'message rounded-lg bg-[#111a22] p-3';
      bubble.innerHTML = '<div class="flex gap-1"><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div></div>';
      
      row.appendChild(icon);
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function hideTyping() {
      const typingIndicator = document.getElementById('typing-indicator');
      if (typingIndicator) {
        typingIndicator.remove();
      }
    }

    async function sendMessage(text) {
      try {
        showTyping();
        
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: text })
        });

        hideTyping();

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.error) {
          addMessage(`Error: ${data.error}`, 'assistant', 'error');
        } else {
          addMessage(data.response, 'assistant', data.type);
        }
      } catch (error) {
        hideTyping();
        console.error('Error sending message:', error);
        addMessage('Sorry, I encountered an error while processing your request. Please try again.', 'assistant', 'error');
      }
    }

    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      
      addMessage(text, 'user');
      input.value = '';
      sendMessage(text);
    });

    sendBtn.addEventListener('click', (e)=>{
      e.preventDefault(); 
      form.dispatchEvent(new Event('submit'));
    });

    document.querySelectorAll('.prompt').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        input.value = btn.textContent;
        form.dispatchEvent(new Event('submit'));
      });
    });

    async function loadSuggestions() {
      try {
        const response = await fetch('/api/suggestions');
        const data = await response.json();
        input.value = data.suggestions[Math.floor(Math.random() * data.suggestions.length)];
      } catch (error) {
        console.error('Error loading suggestions:', error);
        // Fallback suggestions
        const fallbackSuggestions = [
          'What is the current overall risk level?',
          'Is it safe to work today? My pincode is 110001',
          'What safety measures should I take?',
          'How do I handle rockfall alerts?',
        ];
        input.value = fallbackSuggestions[Math.floor(Math.random() * fallbackSuggestions.length)];
      }
    }

    suggestBtn.addEventListener('click', loadSuggestions);

    // Auto-resize textarea
    input.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });

    // Allow Enter to send message, Shift+Enter for new line
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>

